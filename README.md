# 🎹 剑网三自动演奏工具

> 南音三弦专用自动弹奏工具，快去卖艺吧！

![Python](https://img.shields.io/badge/Python-3.7+-blue.svg)
![GUI](https://img.shields.io/badge/GUI-PyQt5-green.svg)
![Game](https://img.shields.io/badge/Game-剑网三-red.svg)
![Version](https://img.shields.io/badge/Version-2.0%20增强版-orange.svg)


**原作者**: 66maer

**二遍**: Mirror

未得到原作者许可，不进行开放

[forked_from](https://github.com/66maer/jx3_piano)

## 🎵 这是什么？

还在羡慕别人弹琴动听，而你却只会瞎按吵闹吗？这个工具可以帮你把 MIDI 文件自动转换成游戏内的按键序列，让你能演奏出美妙的音乐！

简单来说，就是：**按键开启，帮你弹琴** 🎹

## ✨ 新功能特性

### 📝 TXT乐谱导入功能 ⭐ 全新功能
- **直接文本输入** - 支持从TXT文件导入乐谱，无需MIDI文件
- **简单语法** - 使用数字1234567代表do re mi fa so la ti
- **丰富表达** - 支持升降号、音区、时值、演奏技巧、和弦、装饰音
- **实时验证** - 自动检查节拍、小节时值，提供详细错误提示
- **完整兼容** - 转换为标准JSON格式，与现有播放系统无缝集成

### ⚡ 倍速播放功能
- **1.0x (正常速度)** - 保持原始MIDI速度
- **1.25x (1.25倍速)** - 播放速度提升25%，时间减少20%
- **1.5x (1.5倍速)** - 播放速度提升50%，时间减少33.3%
- **1.75x (1.75倍速)** - 播放速度提升75%，时间减少42.9%
- **2.0x (2倍速)** - 播放速度提升100%，时间减少50%

### 🎼 八度变调功能  
- **-8度 (低八度)** - 将所有音符降低一个八度，音域更低沉
- **0度 (不变调)** - 保持原始音高
- **+8度 (高八度)** - 将所有音符升高一个八度，音域更明亮

### 🔥 实时调整功能
- **双重倍速机制** - 支持转换时和播放时的倍速叠加
- **实时速度调整** - 播放过程中可以动态改变速度
- **智能兼容** - 新旧JSON文件完全兼容

### ⌨️ 按键按压时长控制
- **精确控制** - 2ms, 5ms, 10ms, 15ms, 20ms 可选
- **游戏适配** - 根据剑网三游戏响应速度调整
- **实时生效** - 播放时立即应用新设置

## 🚀 快速开始

1. **准备你的 MIDI 文件**
   - 下载或制作 `.mid`
   - 受限于剑网三演奏环境简陋，以及按键频率的问题，`.mid`尽可能不要太多音符与快速升降调
   - 工具只解析前两条音轨，复杂的音轨效果并不好

2. **启动工具**
   - 运行 `剑网三自动演奏工具.exe`
   - 或者如果你是开发者，直接运行 `python gui.py`

3. **配置播放设置** ⭐ 新功能
   - 在左侧 **"⚙️ 播放设置"** 中选择倍速、变调和按键时长
   - **🚀 播放速度**: 选择1.0x - 2.0x的播放倍速
   - **🎼 八度变调**: 选择-8度/不变调/+8度
   - **⌨️ 按键时长**: 选择2ms - 20ms的按键按压时长

4. **导入音乐**
   - **📁 导入MIDI** - 导入传统的MIDI音乐文件
   - **📝 导入TXT乐谱** - 导入文本格式的乐谱文件（新功能）
   - 工具会自动应用你选择的设置并生成按键序列
   - 生成的文件保存在相应的文件夹下

5. **开始演奏**
   - 进入剑网三游戏，使用`南音三弦`挂件，选择高级弹奏
   - 选择工具中的音乐列表，可在播放时调整速度
   - 点击播放，开始表演！

## 🖥️ 界面操作指南

### 控制面板布局
```
🎵 剑网三自动演奏工具
├─ ⚙️ 播放参数
│  ├─ 🚀 播放速度: [1.0x/1.25x/1.5x/1.75x/2.0x]
│  ├─ 🎼 八度变调: [-8度/不变调/+8度]
│  └─ ⌨️ 按键时长: [2ms/5ms/10ms/15ms/20ms]
├─ 🎮 操作控制
│  ├─ 📁 MIDI | 📝 TXT | 🔍 诊断
│  └─ ▶️ 播放 | 🔄 刷新
├─ 🎼 播放列表 - 选择要播放的音乐
└─ 📋 操作日志 - 实时显示操作信息
```

### 操作流程
1. **参数设置** - 先选择播放速度、变调和按键时长
2. **文件导入** - 支持MIDI批量导入和TXT乐谱导入
3. **实时调整** - 播放时可以改变速度，无需重新转换
4. **查看详情** - 文件信息显示转换参数和音符统计
5. **简洁界面** - 白色主题，清晰布局，操作便捷

## 🎯 使用建议

### 🚀 倍速选择指南
| 倍速 | 适用场景 | 播放时长 (2分钟原曲) | 推荐音乐类型 |
|------|---------|---------------------|------------|
| **1.0x** | 速度刚好 | 2分0秒 | 节奏适中的MIDI |
| **1.25x** | 轻微加速 | 1分36秒 | 稍慢的流行歌曲 |
| **1.5x** | 明显加速 | 1分20秒 | 慢歌、抒情音乐 |
| **1.75x** | 显著加速 | 1分8秒 | 很慢的MIDI文件 |
| **2.0x** | 大幅加速 | 1分0秒 | 极慢的古典音乐 |

### 🎼 变调选择指南
- **+8度 (高八度)**: 当音符太低，游戏无法演奏时使用
- **不变调**: 大部分情况下的默认选择
- **-8度 (低八度)**: 当音符太高，超出游戏音域时使用

### ⌨️ 按键时长选择指南
| 时长 | 适用场景 | 推荐使用 |
|------|---------|---------|
| **2ms** | 高速演奏，快速按键序列 | 高速MIDI，快速节奏 |
| **5ms** | 标准演奏，平衡速度和稳定性 | 大部分MIDI文件 |
| **10ms** | 默认设置，确保按键被识别 | 推荐默认选择 |
| **15ms** | 稍慢按键，提高识别率 | 游戏响应较慢时 |
| **20ms** | 慢速按键，确保按键被游戏识别 | 复杂按键组合时 |

### 🧠 智能变调机制 ⭐ 新功能
工具现在采用**智能变调算法**，优先保证主旋律的演奏效果：

#### 变调决策逻辑
1. **主旋律优先**: 分析音轨0（主旋律）的音符覆盖率
2. **80%阈值**: 如果主旋律不变调时覆盖率 ≥80%，保持不变调
3. **整体优化**: 仅当主旋律覆盖率不足时，才寻找最佳整体变调
4. **权重计算**: 主旋律权重为副手的2倍

#### 实际效果
```
🎯 变调分析: 主旋律(音轨0)不变调覆盖率已达85.2%，保持不变调
   ✅ 音轨0 (主旋律): 85.2% (156/183 音符)
   ⚠️ 音轨1 (副手): 67.4% (89/132 音符)
✅ 保持原调
```

### 🎮 游戏中的最佳实践
1. **先测试**: 导入后查看覆盖率和音域信息
2. **调整参数**: 如果覆盖率低，尝试变调
3. **实际试听**: 在游戏中播放，根据感觉调整速度
4. **动态调整**: 播放时可以实时改变速度

## ⚡ 实时倍速功能详解

### 双重倍速机制
现在支持**两级倍速调整**：
1. **转换时倍速**: 生成JSON文件时应用的速度
2. **播放时倍速**: 播放时GUI选择的速度

**最终效果** = 转换时倍速 × 播放时倍速

## 📝 注意事项

- 确保游戏窗口处于活动状态, 使用的是DD驱动，前台按键
- 如果DD驱动加载失败，尝试重启工具即可
- （请在合适的游戏环境中使用，避免影响其他玩家）

## 📝 TXT乐谱语法指南

### 基本格式
第一行，一个整数，表示bpm
第二行，一个分数，表示节拍。目前只支持2/4 3/4 4/4三种
从第三行起，每一行表示一个音轨
```
120        ← BPM（节拍速度）
4/4        ← 节拍（支持2/4、3/4、4/4）
|1 2 3 4|  ← 音轨1，小节内容，用|分隔
|1 0 3 0|  ← 音轨2，小节内容，与上一个音轨同时播放
```

### 音符表示

基本音符：1234567 = do re mi fa so la ti
休止符：0
音区：
`+,-,--,NULL`
随音符走

```
音区标记：
  +1 = 高八度do
  -1 = 低八度do  
  --1 = 超低八度do
  1 = 中音区do（默认）
```

### 升降号

`#,b,NULL`

```
升号：#1 = 升do
降号：b1 = 降do
注意：升降号影响整个音符/和弦/装饰音
```

### 时值标记
`_,__,.,NULL`
```
四分音符：1     （1拍）
八分音符：1_    （0.5拍）
十六分音符：1__ （0.25拍）
附点音符：1.    （1.5拍）
复合时值：1_.   （八分附点 = 0.75拍）
```

### 演奏技巧
`~,*,&,@`
```
上颤音：1~ （先按↑键，弹奏时保持，弹完立即松开）
下颤音：1* （先按↓键，弹奏时保持，弹完立即松开）
泛音：1&   （先按shift键，弹奏时保持，弹完立即松开）
轮指：1@   （先按ctrl键，弹奏时保持，弹完立即松开）
```

### 和弦
推荐三个及以内
`[和弦音]`

```
基本和弦：[135] （同时按下do mi so）
带升降号：#[135] （所有音符都升半音）
带时值：[135]_ （和弦为八分音符）
带技巧：[135]~ （和弦使用上颤音）
```

### 装饰音
装饰音表示框中最后一个音符为主音
`{装饰音1装饰音2...主音}`
```
基本装饰音：{123} （快速弹1 2，然后弹主音3）
带和弦主音：{12[35]} （快速弹1 2，然后弹和弦35）
带修饰：{123}*4 （装饰音结束后弹4，使用下颤音）
```

### 三连音
`<123>`
```
基本三连音：<123> （在一拍时间内平均演奏三个音符）
八分三连音：<123>_ （在半拍时间内平均演奏三个音符）
十六分三连音：<123>__ （在四分之一拍时间内平均演奏三个音符）
带升降号：#<123> （所有音符都升半音）
带技巧：<123>~ （三连音使用上颤音）
含休止符：<101> （第二个音符是休止符）
时间分配：毫秒级精确分配，如100ms分为33ms、33ms、34ms
```

### 复杂音符处理
完整格式逻辑

(升降号)(装饰音'\{')(装饰音音区1)(装饰音音调1)(装饰音音区2)(装饰音音调2)(三连音'<')(和弦'\[')(和弦音音区1)(和弦音音调1)(和弦音音区2)(和弦音音调2)(和弦'\]')(三连音音区2)(三连音音调2)(三连音音区3)(三连音音调3)(三连音'>')(装饰音'\}')(节拍)(浮点)(手法)

```
#{12<[135]23>}_.@
```


### 示例乐谱
```
120
4/4
|1 2 3 4|5 6 7 1|
|[1 3 5] 0 #2 b7|{1 2 3} 4 0 0|
|1_ 2_ 3_ 4_ 5_ 6_ 7_ 0_|+1 +2 +3 +4|
|1~ 2* 3& 4@|0 0 0 0|
```

### 语法检查
- **节拍验证**：每小节音符时值必须等于节拍要求
- **语法检查**：自动检测括号匹配、音符范围等
- **错误提示**：具体指出错误位置和修改建议

## 🔧 技术细节

### 数据格式更新
生成的JSON文件增加了新字段：
- `speed_multiplier`: 存储播放速度倍数
- `octave_transpose`: 存储八度变调设置

### 兼容性说明
- **向后兼容**: 旧版本生成的文件仍可正常播放
- **向前兼容**: 新文件在播放器中会正确应用速度和变调设置

### 技术架构
- **DD驱动**: 使用`dd.54900.dll`进行硬件级输入模拟
- **MIDI解析**: 基于`mido`库进行MIDI文件解析
- **GUI框架**: 使用PyQt5构建用户界面
- **多线程**: 支持后台批量转换和非阻塞播放

## 📊 效果展示

### 转换时的文件信息显示：
```
📊 文件信息:
  🎵 曲目名称: 我的祖国
  🎼 音轨数量: 2
  ⏱️ 总时长: 125.30秒
  🎵 移调: 0半音
  ⚡ 播放速度: 1.5倍        ← 转换时设置
  🎼 八度变调: +1度         ← 转换时设置
  🎹 处理音轨: [0, 1]
  🔢 音符数量: 850
```

### 播放时的速度信息显示：
```
🎵 曲目: 我的祖国
⚡ 播放倍速: 2.0x          ← GUI当前选择
📄 文件倍速: 1.5x          ← 文件生成时设置
🎯 实际倍速: 3.0x          ← 最终效果
📊 统计: 1429个操作, 881个按键, 548个延迟
```

## 🤝 开发者说明

### 项目结构
```
jx3_piano/
├── gui.py              # 主GUI程序
├── build_music.py      # MIDI转换核心模块
├── player.py           # 播放器模块
├── pydd.py            # DD驱动接口
├── dd.54900.dll       # DD驱动文件
├── requirements.txt    # 依赖列表
└── build_exe.py       # 打包脚本
```

### 开发环境
```bash
# 安装依赖
pip install -r requirements.txt

# 运行程序
python gui.py

# 打包程序
python build_exe.py
```

### 贡献指南
如果你也是开发者，欢迎：
- 📝 查看源码并提出建议
- 🐛 报告Bug或问题
- ✨ 贡献新功能代码
- 📖 完善文档说明

---

**作者**: 66maer  ,Mirror二编
**版本**: 2.0 增强版  
**更新日期**: 2025-01-17  
**新功能**: 倍速播放、八度变调、实时调整
